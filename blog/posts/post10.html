<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RONIN // ZERO-DOWNTIME POSTGRES MIGRATION</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- POST SPECIFIC STYLES --- */
        body {
            background-color: #050505 !important;
            color: #ccc !important;
            line-height: 1.8;
        }

        .post-hero {
            position: relative;
            padding: 120px 0;
            border-bottom: 1px solid #333;
            background-image: url('https://placehold.co/1920x600/080808/111111?text=DATABASE_CLUSTER');
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .post-hero::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(5,5,5,0.8), #050505);
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
        }

        .post-body {
            max-width: 740px;
            margin: 0 auto;
            padding: 80px 20px;
            font-size: 1.15rem;
        }

        .post-body h2 {
            font-size: 2rem;
            color: white;
            margin-top: 60px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .post-body h2::before {
            content: '#';
            color: var(--accent);
            font-family: monospace;
            font-size: 1.5rem;
        }

        .post-body p { margin-bottom: 30px; }

        .post-body code {
            background: #1a1a1a;
            color: var(--accent);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.95rem;
            border: 1px solid #333;
        }

        .code-block {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 25px;
            overflow-x: auto;
            margin: 40px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #ddd;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .comment { color: #666; font-style: italic; }
        .keyword { color: #ff5f56; font-weight: bold; }
        .string { color: #27c93f; }
        .function { color: #ffbd2e; }

        .callout {
            border-left: 4px solid var(--accent);
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            margin: 40px 0;
            border-radius: 0 8px 8px 0;
        }

        .callout h3 {
            color: white;
            margin-top: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .diagram-box {
            border: 1px dashed #444;
            padding: 40px;
            font-family: monospace;
            color: var(--accent);
            white-space: pre;
            overflow-x: auto;
            margin: 40px 0;
            text-align: center;
            background: #080808;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* FORCE FOOTER TO BLACK */
        footer {
            background-color: #000 !important;
            border-top: 1px solid #333;
            padding: 60px 0;
            text-align: center;
            color: #666 !important;
        }
    </style>
</head>
<body style="background: #0a0a0a;">

    <header style="background: black; border-bottom: 1px solid #333;">
        <div class="container nav-container">
            <a href="../../index.html" class="logo" style="color: black;">RONIN_COMMS</a>
            <nav class="nav-menu">
                <a href="../blog.html" class="nav-link" style="color: white;">Back to Intel</a>
            </nav>
        </div>
    </header>

    <section class="post-hero">
        <div class="container hero-content">
            <div style="font-family: monospace; color: var(--accent); margin-bottom: 20px; font-size: 14px;">
                // TRANSMISSION_ID: 010 :: TYPE: ENGINEERING_LOG
            </div>
            <h1 style="font-size: clamp(2.5rem, 5vw, 4.5rem); color: white; line-height: 1.1; margin-bottom: 30px;">
                SURGERY ON A <br> <span class="text-highlight">BEATING HEART</span>
            </h1>
            <div style="display: flex; justify-content: center; gap: 30px; font-family: monospace; color: #888; font-size: 14px;">
                <span>AUTHOR: THE ARCHITECT</span>
                <span>::</span>
                <span>JAN 20, 2026</span>
                <span>::</span>
                <span>8 MIN READ</span>
            </div>
        </div>
    </section>

    <article class="post-body">
        
        <p class="lead" style="font-size: 1.4rem; color: white; margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 40px;">
            "Maintenance Windows" are an admission of defeat. If you have to take your site offline to upgrade the database, your architecture is flawed.
        </p>

        <p>
            Last week, our primary Postgres cluster hit 90% IOPS saturation. We needed to move 2TB of live user data to a new NVMe storage array. We did it while processing 15,000 transactions per second. Nobody noticed.
        </p>

        <h2>The Problem: Connection Draining</h2>
        <p>
            The standard enterprise solution (AWS RDS Blue/Green) creates a replica, waits for sync, and then flips DNS. The problem? <strong>DNS propagation is slow.</strong> Clients hang. Connections time out. You get 30 seconds of "502 Bad Gateway" errors.
        </p>
        <p>
            We refuse to accept 30 seconds of downtime. We wanted zero dropped packets.
        </p>

        <h2>The Strategy: Logical Replication Slots</h2>
        <p>
            We didn't use `pg_dump`. We tapped directly into the Postgres **Replication Protocol**. 
        </p>
        <p>
            We wrote a custom Rust binary that pretends to be a Postgres Replica. It connects to the primary DB, creates a <code>logical_replication_slot</code>, and streams the Write-Ahead Log (WAL) in real-time to the new server.
        </p>

        <div class="diagram-box">
   [CLIENT APP]
         |
         v
   +------------+
   | RUST PROXY |  <-- (Holds TCP Connections)
   +------------+
         |
   +-----+----------------+
   |                      |
   v                      v
 [OLD DB] --(WAL)--> [NEW DB]
        </div>

        <h2>The Atomic Cutover</h2>
        <p>
            The magic happens at the Proxy layer. Because Ronin controls the ingress, we don't rely on DNS.
        </p>
        <p>
            When the New DB caught up to the Old DB (0 byte lag), we issued the switch command. Here is exactly what our Rust Proxy did in <strong>4 milliseconds</strong>:
        </p>
        <ol>
            <li><strong>PAUSE:</strong> Stop sending query bytes to the Old DB. Buffer them in RAM.</li>
            <li><strong>SYNC:</strong> Wait for the final WAL LSN (Log Sequence Number) to appear on the New DB.</li>
            <li><strong>SWAP:</strong> Update the connection pool pointer to the New DB IP.</li>
            <li><strong>RESUME:</strong> Flush the RAM buffer to the New DB.</li>
        </ol>

        <div class="code-block">
            <span class="comment">// Inside the Rust Proxy (tokio-postgres)</span><br>
            <span class="keyword">async fn</span> <span class="function">perform_cutover</span>() {<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 1. Pause ingress traffic</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span> buffer = connection.pause_read();<br>
            <br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 2. Wait for LSN catchup</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span> final_lsn = primary.get_current_wal_lsn().await?;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;replica.await_lsn(final_lsn).await?;<br>
            <br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 3. Atomic Pointer Swap</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;GLOBAL_DB_POOL.store(new_pool, Ordering::SeqCst);<br>
            <br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 4. Replay buffer to new target</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;connection.replay(buffer).await;<br>
            }
        </div>

        <div class="callout">
            <h3><i data-lucide="zap"></i> THE RESULT</h3>
            <p>
                The client application didn't even know the database changed. It saw a 4ms latency spike (imperceptible), and the next query response came from the new NVMe drive.
            </p>
        </div>

        <h2>Why This Matters</h2>
        <p>
            Cloud providers sell you "Zero Downtime" as a premium feature that costs $5,000/month. It isn't magic. It's just understanding TCP buffers and the Postgres Replication Protocol.
        </p>
        <p>
            We built Ronin so you don't have to write this Rust code yourself. It's built into the platform.
        </p>

        <hr style="border: 0; border-top: 1px solid #333; margin: 60px 0;">

        <h3>DEPLOY ON A PLATFORM THAT UNDERSTANDS DATA</h3>
        <p>
            Your database is your business. Don't trust it to a black box.
        </p>
        
        <a href="../../index.html" class="btn btn-primary" style="margin-top: 20px;">START DEPLOYING</a>

    </article>

    <footer style="background-color: #000 !important; color: #666 !important; border-top: 1px solid #333; padding: 60px 0; text-align: center;">
        <p style="font-family: monospace; margin: 0;">&copy; 2026 RONIN. NEVER OFFLINE.</p>
    </footer>

</body>
</html>